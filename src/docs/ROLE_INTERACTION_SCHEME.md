# 🔐 Полная Схема Разрешений и Взаимодействий

## 📋 Ролевая Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        REPAIRHUB PRO PLATFORM                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │   КЛИЕНТ     │◄──►│   МАЙСТЕР    │◄──►│   АДМИН      │       │
│  │              │    │              │    │              │       │
│  │ • Создает    │    │ • Видит      │    │ • Управляет  │       │
│  │   заказы     │    │   заказы     │    │   всеми      │       │
│  │ • Принимает  │    │ • Делает     │    │   процессами │       │
│  │   предложения│    │   предложения│    │ • Может      │       │
│  │ • Оплачивает │    │ • Выполняет  │    │   вмешаться  │       │
│  │   через      │    │   работу     │    │   в спор     │       │
│  │   escrow     │    │ • Получает   │    │              │       │
│  └──────────────┘    │   оплату     │    │              │       │
│                       └──────────────┘    └──────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎭 ДЕТАЛЬНЫЕ РАЗРЕШЕНИЯ

### 👤 КЛИЕНТ

#### ✅ МОЖЕТ:
| Действие | Описание | Ограничения |
|----------|----------|-------------|
| 📝 **Создавать заказы** | Создает заявку на ремонт | Только свои устройства |
| 👀 **Просматривать заказы** | Видит свои заказы | Только свои заказы |
| ✏️ **Редактировать заказ** | Изменяет детали заказа | Только до принятия майстром |
| ❌ **Отменять заказ** | Отменяет заказ | До начала работы майстером |
| 💰 **Создавать платеж** | Пополняет escrow | Максимум = стоимости заказа |
| 🔓 **Освобождать платеж** | Оплачивает майстера | Только после выполнения |
| 💬 **Чатить с майстром** | Общается в чате | Только по своему заказу |
| ⭐ **Оценивать работу** | Оставляет отзыв | Только после завершения |
| ⚖️ **Создавать спор** | Начинает спор | Если работа не устроила |
| 📧 **Получать уведомления** | Получает push/SMS/email | Все уведомления о заказах |

#### ❌ НЕ МОЖЕТ:
- ❌ Видеть заказы других клиентов
- ❌ Создавать предложения (это делает майстер)
- ❌ Удалять выполненные заказы
- ❌ Видеть финансовые данные майстров
- ❌ Вмешиваться в работу майстера
- ❌ Отменять заказ после начала работы (только через спор)

---

### 🔧 МАЙСТЕР

#### ✅ МОЖЕТ:
| Действие | Описание | Ограничения |
|----------|----------|-------------|
| 👀 **Просматривать заказы** | Видит все открытые заказы | Только `status: 'open'` |
| 📢 **Создавать предложения** | Предлагает свою цену | Только на открытые заказы |
| ✏️ **Редактировать предложение** | Меняет цену/сроки | До принятия клиентом |
| ❌ **Отменять предложение** | Отменяет свое предложение | Если передумал |
| ✅ **Брать заказы** | Принимает заказ | Если клиент принял предложение |
| 🔧 **Работать над заказом** | Выполняет ремонт | Только назначенные ему |
| ✅ **Завершать работу** | Отмечает заказ как готовый | Только после выполнения |
| 💰 **Получать оплату** | Получает деньги из escrow | Только после release |
| 💬 **Чатить с клиентом** | Общается в чате | Только по своему заказу |
| 📸 **Загружать фото** | Показывает прогресс работы | В чате |
| ⚖️ **Создавать спор** | Оспаривает действия клиента | Если клиент не оплачивает |
| 🚫 **Отменять заказ** | Отменяет работу | Только с объяснением |
| 📊 **Смотреть статистику** | Видит свой рейтинг | Только своя статистика |

#### ❌ НЕ МОЖЕТ:
- ❌ Создавать заказы (только клиенты)
- ❌ Принудительно назначать себя (только по предложению)
- ❌ Изменять статус заказа напрямую
- ❌ Получать оплату до выполнения работы
- ❌ Видеть личные данные других клиентов
- ❌ Блокировать клиентов
- ❌ Видеть чужие заказы после их закрытия

---

### 👑 АДМИН

#### ✅ МОЖЕТ (ВСЁ):
| Категория | Действия |
|-----------|----------|
| 👥 **Управление пользователями** | Создавать, редактировать, блокировать, удалять |
| 📋 **Управление заказами** | Редактировать, удалять, менять статус, назначать майстров |
| 💰 **Управление платежами** | Просматривать все платежи, вручную освобождать/возвращать |
| ⚖️ **Арбитраж споров** | Решать споры, эскалировать, закрывать |
| 💬 **Управление чатами** | Читать переписки, модерировать |
| 📊 **Аналитика** | Видеть всю статистику, экспорт данных |
| ⚙️ **Настройки системы** | Менять тарифы, управлять комиссиями |
| 🚨 **Безопасность** | Банить пользователей, блокировать заказы |
| 📢 **Уведомления** | Отправлять массовые уведомления |
| 🗄️ **База данных** | Прямой доступ к данным |

#### ❌ НЕ МОЖЕТ (технически):
- ❌ Создавать заказы от своего имени (может, но технически)
- ❌ Видеть пароли пользователей (в базе только хэши)
- ❌ Изменять код приложения (не через админку)

---

## 🔄 WORKFLOW ВЗАИМОДЕЙСТВИЙ

### 1️⃣ СОЗДАНИЕ И ИСПОЛНЕНИЕ ЗАКАЗА

```
┌────────────────────────────────────────────────────────────┐
│  КЛИЕНТ → МАЙСТЕР → АДМИН (если есть спор)                  │
└────────────────────────────────────────────────────────────┘

1. КЛИЕНТ СОЗДАЕТ ЗАКАЗ
   ├─ Описывает проблему
   ├─ Указывает бренд/модель
   ├─ Устанавливает бюджет
   ├─ Указывает город
   └─ Status: 'open'
        ↓
2. МАЙСТРЫ ВИДЯТ ЗАКАЗ
   ├─ Просматривают детали
   ├─ Оценивают сложность
   └─ Создают предложения
        ↓
3. МАЙСТЕР СОЗДАЕТ ПРЕДЛОЖЕНИЕ
   ├─ Указывает цену
   ├─ Указывает сроки
   ├─ Добавляет комментарий
   └─ Status: 'proposed'
        ↓
4. КЛИЕНТ ВЫБИРАЕТ МАЙСТРА
   ├─ Просматривает предложения
   ├─ Проверяет рейтинг
   ├─ Принимает предложение
   └─ Status: 'accepted'
        ↓
5. КЛИЕНТ ОПЛАЧИВАЕТ В ESCROW
   ├─ Пополняет баланс
   ├─ Money в escrow
   └─ Status: 'in_progress'
        ↓
6. МАЙСТЕР ВЫПОЛНЯЕТ РАБОТУ
   ├─ Обновляет прогресс в чате
   ├─ Отправляет фото
   └─ Отмечает как "готово"
        ↓
7. КЛИЕНТ ПРОВЕРЯЕТ РАБОТУ
   ├─ Если ОК: Release payment
   └─ Status: 'completed'
        ↓
8. МАЙСТЕР ПОЛУЧАЕТ ОПЛАТУ
   └─ Деньги переходят в balance
```

---

### 2️⃣ СПОРНЫЙ СЛУЧАЙ (ДИСПУТ)

```
┌────────────────────────────────────────────────────────────┐
│  Если клиент НЕ доволен работой:                           │
└────────────────────────────────────────────────────────────┘

1. КЛИЕНТ СОЗДАЕТ СПОР
   ├─ Указывает причину
   ├─ Описывает проблему
   └─ Status: 'disputed'
        ↓
2. МАЙСТЕР ПОЛУЧАЕТ УВЕДОМЛЕНИЕ
   ├─ Может прокомментировать
   ├─ Добавить фото/доказательства
   └─ Status: 'disputed'
        ↓
3. АДМИН ВМЕШИВАЕТСЯ
   ├─ Просматривает чат
   ├─ Смотрит фото
   ├─ Проверяет историю
   └─ ПРИНИМАЕТ РЕШЕНИЕ:
        ├─ A) Работа выполнена → Release payment майстру
        ├─ B) Работа не выполнена → Refund клиенту
        ├─ C) Частично → Пропорциональное разделение
        └─ D) Обе стороны виноваты → Компромисс
        ↓
4. РЕЗУЛЬТАТ
   ├─ Status: 'completed' или 'cancelled'
   └─ Платеж обработан
```

---

### 3️⃣ ОТМЕНА ЗАКАЗА

#### A) ОТМЕНА КЛИЕНТОМ:
```
Клиент может отменить:
├─ До принятия майстром (Status: 'open')
├─ После принятия, но до начала работы (Status: 'accepted')
└─ После начала работы - ТОЛЬКО через спор
```

#### B) ОТМЕНА МАЙСТРОМ:
```
Майстер может отменить:
├─ До принятия клиентом (статус предложения: 'pending')
├─ После начала работы - ТОЛЬКО с объяснением
└─ Эскроу возвращается клиенту автоматически
```

#### C) ОТМЕНА АДМИНОМ:
```
Админ может отменить:
├─ В любой момент
├─ По любой причине
└─ С объяснением всем сторонам
```

---

## 🔒 МАТРИЦА РАЗРЕШЕНИЙ

### 📊 Детальная таблица:

| Действие | КЛИЕНТ | МАЙСТЕР | АДМИН |
|----------|:------:|:------:|:-----:|
| **ЗАКАЗЫ** |
| Создавать заказ | ✅ | ❌ | ✅ |
| Читать свои заказы | ✅ | ❌ | ✅ |
| Читать другие заказы | ❌ | ⚠️ Только open | ✅ |
| Редактировать заказ | ✅ До accepted | ❌ | ✅ |
| Удалять заказ | ✅ | ❌ | ✅ |
| Менять статус | ⚠️ Частично | ⚠️ Частично | ✅ |
| **ПРЕДЛОЖЕНИЯ** |
| Создавать предложение | ❌ | ✅ | ❌ |
| Редактировать предложение | ❌ | ✅ До accepted | ✅ |
| Принимать предложение | ✅ | ❌ | ✅ |
| Отклонять предложение | ✅ | ❌ | ✅ |
| **ПЛАТЕЖИ** |
| Создавать платеж | ✅ | ❌ | ✅ |
| Пополнять escrow | ✅ | ❌ | ✅ |
| Release payment | ✅ После completed | ❌ | ✅ |
| Получать оплату | ❌ | ✅ После release | ❌ |
| Refund payment | ❌ | ❌ | ✅ |
| **ЧАТ** |
| Отправлять сообщения | ✅ Только по своим заказам | ✅ Только по своим заказам | ✅ Все |
| Читать переписку | ✅ Только свои | ✅ Только свои | ✅ Все |
| Загружать фото | ✅ | ✅ | ✅ |
| **ДИСПУТЫ** |
| Создавать спор | ✅ | ✅ | ❌ Не нужно |
| Решать спор | ❌ | ❌ | ✅ |
| Эскалировать спор | ❌ | ❌ | ✅ |
| **ПРОФИЛЬ** |
| Редактировать свой профиль | ✅ | ✅ | ✅ |
| Редактировать чужой профиль | ❌ | ❌ | ✅ |
| Просматривать чужой профиль | ⚠️ Ограниченно | ⚠️ Ограниченно | ✅ |
| **СТАТИСТИКА** |
| Своя статистика | ✅ | ✅ | ✅ |
| Чужая статистика | ❌ | ❌ | ✅ |
| Вся статистика | ❌ | ❌ | ✅ |

---

## 🎯 ПРАВИЛА БИЗНЕС-ЛОГИКИ

### 1. Создание заказа:
```typescript
IF currentUser.role === 'client':
  ✅ Может создать заказ
  ❌ Может установить любой статус
ELSE IF currentUser.role === 'master':
  ❌ НЕ может создать заказ
  ℹ️ Только предложения
ELSE IF currentUser.role === 'admin':
  ✅ Может создать заказ от имени клиента
```

### 2. Создание предложения:
```typescript
IF currentUser.role === 'master' AND order.status === 'open':
  ✅ Может создать предложение
  ❌ Не может предложить на свой заказ
  ✅ Может изменить цену до принятия
ELSE:
  ❌ Не может создать предложение
```

### 3. Принятие предложения:
```typescript
IF currentUser.role === 'client' AND order.clientId === currentUser.id:
  ✅ Может принять
  ❌ Автоматически отклоняет все остальные
  ✅ Меняет статус на 'accepted' → 'in_progress'
ELSE:
  ❌ Не может принять
```

### 4. Освобождение платежа:
```typescript
IF currentUser.role === 'client' AND order.status === 'in_progress':
  ✅ Может release payment
  ✅ Автоматически переводит майстру
ELSE IF currentUser.role === 'admin':
  ✅ Может принудительно release
ELSE:
  ❌ Не может
```

### 5. Спор:
```typescript
IF order.status === 'in_progress' OR 'completed':
  ✅ КЛИЕНТ может создать спор
  ✅ МАЙСТЕР может создать спор
  ✅ Эскроу замораживается
  ✅ Админ может решить
ELSE:
  ❌ Нельзя создать спор на open/сancelled
```

---

## 🛡️ БЕЗОПАСНОСТЬ

### Уровни доступа:

```
┌──────────────────────────────────────┐
│           ПУБЛИЧНАЯ ЗОНА             │
│  • Лендинг                           │
│  • Регистрация/Логин                 │
└──────────────────────────────────────┘
              ↓
┌──────────────────────────────────────┐
│           КЛИЕНТСКАЯ ЗОНА            │
│  • Мои заказы (только свои)          │
│  • Мой профиль                       │
│  • Мои устройства                    │
│  • Мои платежи                       │
└──────────────────────────────────────┘
              ↓
┌──────────────────────────────────────┐
│          МАЙСТЕРСКАЯ ЗОНА             │
│  • Открытые заказы (open)            │
│  • Мои предложения                    │
│  • Назначенные мне заказы            │
│  • Статистика                         │
└──────────────────────────────────────┘
              ↓
┌──────────────────────────────────────┐
│           АДМИН ЗОНА                  │
│  • ВСЁ                                │
│  • Все заказы/пользователи           │
│  • Споры и арбитраж                   │
│  • Аналитика и финансы                │
└──────────────────────────────────────┘
```

---

## 📝 ИТОГОВАЯ СХЕМА:

```
КЛИЕНТ                 МАЙСТЕР              АДМИН
  │                       │                   │
  ├─ Создает заказ ──────►│                   │
  │                       │                   │
  │                    Предложение ───────────►│
  │                       │                   │
  │←─ Принимает           │                   │
  │                       │                   │
  ├─ Оплачивает          │                   │
  │  (escrow)            │                   │
  │                       │                   │
  │←─ Выполняет ──────────┤                   │
  │                       │                   │
  ├─ Release             │                   │
  │  (платеж)             │                   │
  │                       │←─ Получает        │
  │                       │                   │
  │                       │                   │
  ├─ СПОР ───────────────►│                   │
  │              ────────────────► АДМИН ────►│
  │                       │     Решает    ◄───┤
  │                       │                   │
  └──────────────────────────────────────────┘
```

---

**Версия:** 1.0  
**Дата:** 28 октября 2025  
**Автор:** RepairHUB Pro Development Team

