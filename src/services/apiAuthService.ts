// src/services/apiAuthService.ts
import axios from 'axios';
import { User } from '../types';
import { getApiUrl, getAuthHeaders } from './apiUrlHelper';

// Debug: log API URL on initialization
if (import.meta.env.DEV) {
  console.log('üîó API URL:', getApiUrl());
}

class ApiAuthService {
  private static instance: ApiAuthService;

  private constructor() {}

  public static getInstance(): ApiAuthService {
    if (!ApiAuthService.instance) {
      ApiAuthService.instance = new ApiAuthService();
    }
    return ApiAuthService.instance;
  }

  public async login(email: string, password?: string): Promise<User | null> {
    try {
      const requestData = password ? { email, password } : { email };
      const response = await axios.post(`${getApiUrl()}/auth/login`, requestData, {
        withCredentials: true,
        headers: getAuthHeaders(),
      });
      
      const { token, user } = response.data;
      
      if (token) {
        localStorage.setItem('jwt-token', token);
      }
      
      return user;
    } catch (apiError) {
      // –Ø–∫—â–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É
      throw new Error(apiError instanceof Error ? apiError.message : '–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å');
    }
  }

  public async register(user: User): Promise<User> {
    const response = await axios.post(`${getApiUrl()}/auth/register`, user, {
      withCredentials: true,
      headers: getAuthHeaders(),
    });
    return response.data;
  }

  public async me(): Promise<User | null> {
    try {
      const response = await axios.get(`${getApiUrl()}/auth/me`, {
        withCredentials: true,
        headers: getAuthHeaders(),
      });
      return response.data?.user || null;
    } catch (error) {
      // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ
      if (import.meta.env.DEV) {
        console.warn('Failed to fetch current user:', error);
      }
      return null;
    }
  }

  public async logout(): Promise<void> {
    try {
      await axios.post(`${getApiUrl()}/auth/logout`, undefined, {
        withCredentials: true,
        headers: getAuthHeaders(),
      });
    } catch (error) {
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É logout —Ç–æ–ª—å–∫–æ –≤ dev
      if (import.meta.env.DEV) {
        console.warn('Logout API call failed (non-critical):', error);
      }
    } finally {
      // –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ
      localStorage.removeItem('jwt-token');
    }
  }
}

export const apiAuthService = ApiAuthService.getInstance();
